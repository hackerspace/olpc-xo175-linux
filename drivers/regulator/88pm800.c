/*
 * Regulators driver for Marvell 88PM800
 *
 * Copyright (C) 2009 Marvell International Ltd.
 * Joseph(Yossi) Hanin <yhanin@marvell.com>
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License version 2 as
 * published by the Free Software Foundation.
 */
#include <linux/kernel.h>
#include <linux/init.h>
#include <linux/err.h>
#include <linux/i2c.h>
#include <linux/platform_device.h>
#include <linux/regulator/driver.h>
#include <linux/regulator/machine.h>
#include <linux/mfd/core.h>
#include <linux/mfd/88pm80x.h>

struct pm800_regulator_info {
	struct regulator_desc	desc;
	struct pm80x_chip	*chip;
	struct regulator_dev	*regulator;
	struct i2c_client	*i2c;

	unsigned int	*vol_table;
	unsigned int	*vol_suspend;

	int	vol_reg;
	int	vol_shift;
	int	vol_nbits;
	int	update_reg;
	int	update_bit;
	int	enable_reg;
	int	enable_bit;

/*- in PM800 there are 2 range:
		from 0x00 to 0x3F VOUT step
		is 0.0125V, range is from 0.6V to 1.3875V.
		and
		from 0x40 to 0x7F VOUT step
		is 0.05V, range is from 1.4V to 4.550V:
		which is (V * 7/3) and not exactly double (2.33)*/
	int	slope_double;
};


static const unsigned int BUCK1_table[] = {
	600000, 612500, 625000, 637500, 650000, 662500, 675000, 687500,
	700000, 712500, 725000, 737500, 750000, 762500, 775000, 787500,
	800000, 812500, 825000, 837500, 850000, 862500, 875000, 887500,
	900000, 912500, 925000, 937500, 950000, 962500, 975000, 987500,
	1000000, 1012500, 1025000, 1037500, 1050000, 1062500, 1075000, 1087500,
	1100000, 1112500, 1125000, 1137500, 1150000, 1162500, 1175000, 1187500,
	1200000, 1212500, 1225000, 1237500, 1250000, 1262500, 1275000, 1287500,
	1300000, 1312500, 1325000, 1337500, 1350000, 1362500, 1375000, 1387500,
};

static const unsigned int BUCK1_suspend_table[] = {
	600000, 612500, 625000, 637500, 650000, 662500, 675000, 687500,
	700000, 712500, 725000, 737500, 750000, 762500, 775000, 787500,
	800000, 812500, 825000, 837500, 850000, 862500, 875000, 887500,
	900000, 912500, 925000, 937500, 950000, 962500, 975000, 987500,
	1000000, 1012500, 1025000, 1037500, 1050000, 1062500, 1075000, 1087500,
	1100000, 1112500, 1125000, 1137500, 1150000, 1162500, 1175000, 1187500,
	1200000, 1212500, 1225000, 1237500, 1250000, 1262500, 1275000, 1287500,
	1300000, 1312500, 1325000, 1337500, 1350000, 1362500, 1375000, 1387500,
};

static const unsigned int BUCK2_table[] = {
	600000, 612500, 625000, 637500, 650000, 662500, 675000, 687500,
	700000, 712500, 725000, 737500, 750000, 762500, 775000, 787500,
	800000, 812500, 825000, 837500, 850000, 862500, 875000, 887500,
	900000, 912500, 925000, 937500, 950000, 962500, 975000, 987500,
	1000000, 1012500, 1025000, 1037500, 1050000, 1062500, 1075000, 1087500,
	1100000, 1112500, 1125000, 1137500, 1150000, 1162500, 1175000, 1187500,
	1200000, 1212500, 1225000, 1237500, 1250000, 1262500, 1275000, 1287500,
	1300000, 1312500, 1325000, 1337500, 1350000, 1362500, 1375000, 1387500,
};

static const unsigned int BUCK2_suspend_table[] = {
	600000, 612500, 625000, 637500, 650000, 662500, 675000, 687500,
	700000, 712500, 725000, 737500, 750000, 762500, 775000, 787500,
	800000, 812500, 825000, 837500, 850000, 862500, 875000, 887500,
	900000, 912500, 925000, 937500, 950000, 962500, 975000, 987500,
	1000000, 1012500, 1025000, 1037500, 1050000, 1062500, 1075000, 1087500,
	1100000, 1112500, 1125000, 1137500, 1150000, 1162500, 1175000, 1187500,
	1200000, 1212500, 1225000, 1237500, 1250000, 1262500, 1275000, 1287500,
	1300000, 1312500, 1325000, 1337500, 1350000, 1362500, 1375000, 1387500,
};

static const unsigned int BUCK3_table[] = {
	600000, 612500, 625000, 637500, 650000, 662500, 675000, 687500,
	700000, 712500, 725000, 737500, 750000, 762500, 775000, 787500,
	800000, 812500, 825000, 837500, 850000, 862500, 875000, 887500,
	900000, 912500, 925000, 937500, 950000, 962500, 975000, 987500,
	1000000, 1012500, 1025000, 1037500, 1050000, 1062500, 1075000, 1087500,
	1100000, 1112500, 1125000, 1137500, 1150000, 1162500, 1175000, 1187500,
	1200000, 1212500, 1225000, 1237500, 1250000, 1262500, 1275000, 1287500,
	1300000, 1312500, 1325000, 1337500, 1350000, 1362500, 1375000, 1387500,
};

static const unsigned int BUCK3_suspend_table[] = {
	600000, 612500, 625000, 637500, 650000, 662500, 675000, 687500,
	700000, 712500, 725000, 737500, 750000, 762500, 775000, 787500,
	800000, 812500, 825000, 837500, 850000, 862500, 875000, 887500,
	900000, 912500, 925000, 937500, 950000, 962500, 975000, 987500,
	1000000, 1012500, 1025000, 1037500, 1050000, 1062500, 1075000, 1087500,
	1100000, 1112500, 1125000, 1137500, 1150000, 1162500, 1175000, 1187500,
	1200000, 1212500, 1225000, 1237500, 1250000, 1262500, 1275000, 1287500,
	1300000, 1312500, 1325000, 1337500, 1350000, 1362500, 1375000, 1387500,
};

static const unsigned int BUCK4_table[] = {
	600000, 612500, 625000, 637500, 650000, 662500, 675000, 687500,
	700000, 712500, 725000, 737500, 750000, 762500, 775000, 787500,
	800000, 812500, 825000, 837500, 850000, 862500, 875000, 887500,
	900000, 912500, 925000, 937500, 950000, 962500, 975000, 987500,
	1000000, 1012500, 1025000, 1037500, 1050000, 1062500, 1075000, 1087500,
	1100000, 1112500, 1125000, 1137500, 1150000, 1162500, 1175000, 1187500,
	1200000, 1212500, 1225000, 1237500, 1250000, 1262500, 1275000, 1287500,
	1300000, 1312500, 1325000, 1337500, 1350000, 1362500, 1375000, 1387500,
};

static const unsigned int BUCK4_suspend_table[] = {
	600000, 612500, 625000, 637500, 650000, 662500, 675000, 687500,
	700000, 712500, 725000, 737500, 750000, 762500, 775000, 787500,
	800000, 812500, 825000, 837500, 850000, 862500, 875000, 887500,
	900000, 912500, 925000, 937500, 950000, 962500, 975000, 987500,
	1000000, 1012500, 1025000, 1037500, 1050000, 1062500, 1075000, 1087500,
	1100000, 1112500, 1125000, 1137500, 1150000, 1162500, 1175000, 1187500,
	1200000, 1212500, 1225000, 1237500, 1250000, 1262500, 1275000, 1287500,
	1300000, 1312500, 1325000, 1337500, 1350000, 1362500, 1375000, 1387500,
};

static const unsigned int BUCK5_table[] = {
	600000, 612500, 625000, 637500, 650000, 662500, 675000, 687500,
	700000, 712500, 725000, 737500, 750000, 762500, 775000, 787500,
	800000, 812500, 825000, 837500, 850000, 862500, 875000, 887500,
	900000, 912500, 925000, 937500, 950000, 962500, 975000, 987500,
	1000000, 1012500, 1025000, 1037500, 1050000, 1062500, 1075000, 1087500,
	1100000, 1112500, 1125000, 1137500, 1150000, 1162500, 1175000, 1187500,
	1200000, 1212500, 1225000, 1237500, 1250000, 1262500, 1275000, 1287500,
	1300000, 1312500, 1325000, 1337500, 1350000, 1362500, 1375000, 1387500,
};

static const unsigned int BUCK5_suspend_table[] = {
	600000, 612500, 625000, 637500, 650000, 662500, 675000, 687500,
	700000, 712500, 725000, 737500, 750000, 762500, 775000, 787500,
	800000, 812500, 825000, 837500, 850000, 862500, 875000, 887500,
	900000, 912500, 925000, 937500, 950000, 962500, 975000, 987500,
	1000000, 1012500, 1025000, 1037500, 1050000, 1062500, 1075000, 1087500,
	1100000, 1112500, 1125000, 1137500, 1150000, 1162500, 1175000, 1187500,
	1200000, 1212500, 1225000, 1237500, 1250000, 1262500, 1275000, 1287500,
	1300000, 1312500, 1325000, 1337500, 1350000, 1362500, 1375000, 1387500,
};


static const unsigned int LDO1_table[] = {
	600000, 650000, 700000, 750000, 800000, 850000, 900000, 950000, 1000000,
	1050000, 1100000, 1150000, 1200000, 1250000, 1300000, 1350000, 1400000,
	1450000, 1500000,
};

static const unsigned int LDO1_suspend_table[] = {
	600000, 650000, 700000, 750000, 800000, 850000, 900000, 950000, 1000000,
	1050000, 1100000, 1150000, 1200000, 1250000, 1300000, 1350000, 1400000,
	1450000, 1500000,
};

static const unsigned int LDO2_table[] = {
	600000, 650000, 700000, 750000, 800000, 850000, 900000, 950000, 1000000,
	1050000, 1100000, 1150000, 1200000, 1250000, 1300000, 1350000, 1400000,
	1450000, 1500000,
};

static const unsigned int LDO2_suspend_table[] = {
	600000, 650000, 700000, 750000, 800000, 850000, 900000, 950000, 1000000,
	1050000, 1100000, 1150000, 1200000, 1250000, 1300000, 1350000, 1400000,
	1450000, 1500000,
};

static const unsigned int LDO3_table[] = {
	1200000, 1250000, 1300000, 1350000, 1400000, 1450000, 1500000, 1550000,
	1600000, 1650000, 1700000, 1750000, 1800000, 1850000, 1900000, 1950000,
	2000000, 2050000, 2100000, 2150000, 2200000, 2250000, 2300000, 2350000,
	2400000, 2450000, 2500000, 2550000, 2600000, 2650000, 2700000, 2750000,
	2800000, 2850000, 2900000, 2950000, 3000000, 3050000, 3100000, 3150000,
	3200000, 3250000, 3300000,
};

static const unsigned int LDO3_suspend_table[] = {
	1200000, 1250000, 1300000, 1350000, 1400000, 1450000, 1500000, 1550000,
	1600000, 1650000, 1700000, 1750000, 1800000, 1850000, 1900000, 1950000,
	2000000, 2050000, 2100000, 2150000, 2200000, 2250000, 2300000, 2350000,
	2400000, 2450000, 2500000, 2550000, 2600000, 2650000, 2700000, 2750000,
	2800000, 2850000, 2900000, 2950000, 3000000, 3050000, 3100000, 3150000,
	3200000, 3250000, 3300000,
};

static const unsigned int LDO4_table[] = {
	1200000, 1250000, 1300000, 1350000, 1400000, 1450000, 1500000, 1550000,
	1600000, 1650000, 1700000, 1750000, 1800000, 1850000, 1900000, 1950000,
	2000000, 2050000, 2100000, 2150000, 2200000, 2250000, 2300000, 2350000,
	2400000, 2450000, 2500000, 2550000, 2600000, 2650000, 2700000, 2750000,
	2800000, 2850000, 2900000, 2950000, 3000000, 3050000, 3100000, 3150000,
	3200000, 3250000, 3300000,
};

static const unsigned int LDO4_suspend_table[] = {
	1200000, 1250000, 1300000, 1350000, 1400000, 1450000, 1500000, 1550000,
	1600000, 1650000, 1700000, 1750000, 1800000, 1850000, 1900000, 1950000,
	2000000, 2050000, 2100000, 2150000, 2200000, 2250000, 2300000, 2350000,
	2400000, 2450000, 2500000, 2550000, 2600000, 2650000, 2700000, 2750000,
	2800000, 2850000, 2900000, 2950000, 3000000, 3050000, 3100000, 3150000,
	3200000, 3250000, 3300000,
};

static const unsigned int LDO5_table[] = {
	1200000, 1250000, 1300000, 1350000, 1400000, 1450000, 1500000, 1550000,
	1600000, 1650000, 1700000, 1750000, 1800000, 1850000, 1900000, 1950000,
	2000000, 2050000, 2100000, 2150000, 2200000, 2250000, 2300000, 2350000,
	2400000, 2450000, 2500000, 2550000, 2600000, 2650000, 2700000, 2750000,
	2800000, 2850000, 2900000, 2950000, 3000000, 3050000, 3100000, 3150000,
	3200000, 3250000, 3300000,
};

static const unsigned int LDO5_suspend_table[] = {
	1200000, 1250000, 1300000, 1350000, 1400000, 1450000, 1500000, 1550000,
	1600000, 1650000, 1700000, 1750000, 1800000, 1850000, 1900000, 1950000,
	2000000, 2050000, 2100000, 2150000, 2200000, 2250000, 2300000, 2350000,
	2400000, 2450000, 2500000, 2550000, 2600000, 2650000, 2700000, 2750000,
	2800000, 2850000, 2900000, 2950000, 3000000, 3050000, 3100000, 3150000,
	3200000, 3250000, 3300000,
};

static const unsigned int LDO6_table[] = {
	1200000, 1250000, 1300000, 1350000, 1400000, 1450000, 1500000, 1550000,
	1600000, 1650000, 1700000, 1750000, 1800000, 1850000, 1900000, 1950000,
	2000000, 2050000, 2100000, 2150000, 2200000, 2250000, 2300000, 2350000,
	2400000, 2450000, 2500000, 2550000, 2600000, 2650000, 2700000, 2750000,
	2800000, 2850000, 2900000, 2950000, 3000000, 3050000, 3100000, 3150000,
	3200000, 3250000, 3300000,
};

static const unsigned int LDO6_suspend_table[] = {
	1200000, 1250000, 1300000, 1350000, 1400000, 1450000, 1500000, 1550000,
	1600000, 1650000, 1700000, 1750000, 1800000, 1850000, 1900000, 1950000,
	2000000, 2050000, 2100000, 2150000, 2200000, 2250000, 2300000, 2350000,
	2400000, 2450000, 2500000, 2550000, 2600000, 2650000, 2700000, 2750000,
	2800000, 2850000, 2900000, 2950000, 3000000, 3050000, 3100000, 3150000,
	3200000, 3250000, 3300000,
};

static const unsigned int LDO7_table[] = {
	1200000, 1250000, 1300000, 1350000, 1400000, 1450000, 1500000, 1550000,
	1600000, 1650000, 1700000, 1750000, 1800000, 1850000, 1900000, 1950000,
	2000000, 2050000, 2100000, 2150000, 2200000, 2250000, 2300000, 2350000,
	2400000, 2450000, 2500000, 2550000, 2600000, 2650000, 2700000, 2750000,
	2800000, 2850000, 2900000, 2950000, 3000000, 3050000, 3100000, 3150000,
	3200000, 3250000, 3300000,
};

static const unsigned int LDO7_suspend_table[] = {
	1200000, 1250000, 1300000, 1350000, 1400000, 1450000, 1500000, 1550000,
	1600000, 1650000, 1700000, 1750000, 1800000, 1850000, 1900000, 1950000,
	2000000, 2050000, 2100000, 2150000, 2200000, 2250000, 2300000, 2350000,
	2400000, 2450000, 2500000, 2550000, 2600000, 2650000, 2700000, 2750000,
	2800000, 2850000, 2900000, 2950000, 3000000, 3050000, 3100000, 3150000,
	3200000, 3250000, 3300000,
};

static const unsigned int LDO8_table[] = {
	1200000, 1250000, 1300000, 1350000, 1400000, 1450000, 1500000, 1550000,
	1600000, 1650000, 1700000, 1750000, 1800000, 1850000, 1900000, 1950000,
	2000000, 2050000, 2100000, 2150000, 2200000, 2250000, 2300000, 2350000,
	2400000, 2450000, 2500000, 2550000, 2600000, 2650000, 2700000, 2750000,
	2800000, 2850000, 2900000, 2950000, 3000000, 3050000, 3100000, 3150000,
	3200000, 3250000, 3300000,
};

static const unsigned int LDO8_suspend_table[] = {
	1200000, 1250000, 1300000, 1350000, 1400000, 1450000, 1500000, 1550000,
	1600000, 1650000, 1700000, 1750000, 1800000, 1850000, 1900000, 1950000,
	2000000, 2050000, 2100000, 2150000, 2200000, 2250000, 2300000, 2350000,
	2400000, 2450000, 2500000, 2550000, 2600000, 2650000, 2700000, 2750000,
	2800000, 2850000, 2900000, 2950000, 3000000, 3050000, 3100000, 3150000,
	3200000, 3250000, 3300000,
};

static const unsigned int LDO9_table[] = {
	1200000, 1250000, 1300000, 1350000, 1400000, 1450000, 1500000, 1550000,
	1600000, 1650000, 1700000, 1750000, 1800000, 1850000, 1900000, 1950000,
	2000000, 2050000, 2100000, 2150000, 2200000, 2250000, 2300000, 2350000,
	2400000, 2450000, 2500000, 2550000, 2600000, 2650000, 2700000, 2750000,
	2800000, 2850000, 2900000, 2950000, 3000000, 3050000, 3100000, 3150000,
	3200000, 3250000, 3300000,
};

static const unsigned int LDO9_suspend_table[] = {
	1200000, 1250000, 1300000, 1350000, 1400000, 1450000, 1500000, 1550000,
	1600000, 1650000, 1700000, 1750000, 1800000, 1850000, 1900000, 1950000,
	2000000, 2050000, 2100000, 2150000, 2200000, 2250000, 2300000, 2350000,
	2400000, 2450000, 2500000, 2550000, 2600000, 2650000, 2700000, 2750000,
	2800000, 2850000, 2900000, 2950000, 3000000, 3050000, 3100000, 3150000,
	3200000, 3250000, 3300000,
};

static const unsigned int LDO10_table[] = {
	1200000, 1250000, 1300000, 1350000, 1400000, 1450000, 1500000, 1550000,
	1600000, 1650000, 1700000, 1750000, 1800000, 1850000, 1900000, 1950000,
	2000000, 2050000, 2100000, 2150000, 2200000, 2250000, 2300000, 2350000,
	2400000, 2450000, 2500000, 2550000, 2600000, 2650000, 2700000, 2750000,
	2800000, 2850000, 2900000, 2950000, 3000000, 3050000, 3100000, 3150000,
	3200000, 3250000, 3300000,
};

static const unsigned int LDO10_suspend_table[] = {
	1200000, 1250000, 1300000, 1350000, 1400000, 1450000, 1500000, 1550000,
	1600000, 1650000, 1700000, 1750000, 1800000, 1850000, 1900000, 1950000,
	2000000, 2050000, 2100000, 2150000, 2200000, 2250000, 2300000, 2350000,
	2400000, 2450000, 2500000, 2550000, 2600000, 2650000, 2700000, 2750000,
	2800000, 2850000, 2900000, 2950000, 3000000, 3050000, 3100000, 3150000,
	3200000, 3250000, 3300000,
};
static const unsigned int LDO11_table[] = {
	1200000, 1250000, 1300000, 1350000, 1400000, 1450000, 1500000, 1550000,
	1600000, 1650000, 1700000, 1750000, 1800000, 1850000, 1900000, 1950000,
	2000000, 2050000, 2100000, 2150000, 2200000, 2250000, 2300000, 2350000,
	2400000, 2450000, 2500000, 2550000, 2600000, 2650000, 2700000, 2750000,
	2800000, 2850000, 2900000, 2950000, 3000000, 3050000, 3100000, 3150000,
	3200000, 3250000, 3300000,
};

static const unsigned int LDO11_suspend_table[] = {
	1200000, 1250000, 1300000, 1350000, 1400000, 1450000, 1500000, 1550000,
	1600000, 1650000, 1700000, 1750000, 1800000, 1850000, 1900000, 1950000,
	2000000, 2050000, 2100000, 2150000, 2200000, 2250000, 2300000, 2350000,
	2400000, 2450000, 2500000, 2550000, 2600000, 2650000, 2700000, 2750000,
	2800000, 2850000, 2900000, 2950000, 3000000, 3050000, 3100000, 3150000,
	3200000, 3250000, 3300000,
};
static const unsigned int LDO12_table[] = {
	1200000, 1250000, 1300000, 1350000, 1400000, 1450000, 1500000, 1550000,
	1600000, 1650000, 1700000, 1750000, 1800000, 1850000, 1900000, 1950000,
	2000000, 2050000, 2100000, 2150000, 2200000, 2250000, 2300000, 2350000,
	2400000, 2450000, 2500000, 2550000, 2600000, 2650000, 2700000, 2750000,
	2800000, 2850000, 2900000, 2950000, 3000000, 3050000, 3100000, 3150000,
	3200000, 3250000, 3300000,
};

static const unsigned int LDO12_suspend_table[] = {
	1200000, 1250000, 1300000, 1350000, 1400000, 1450000, 1500000, 1550000,
	1600000, 1650000, 1700000, 1750000, 1800000, 1850000, 1900000, 1950000,
	2000000, 2050000, 2100000, 2150000, 2200000, 2250000, 2300000, 2350000,
	2400000, 2450000, 2500000, 2550000, 2600000, 2650000, 2700000, 2750000,
	2800000, 2850000, 2900000, 2950000, 3000000, 3050000, 3100000, 3150000,
	3200000, 3250000, 3300000,
};

static const unsigned int LDO13_table[] = {
	1200000, 1250000, 1300000, 1350000, 1400000, 1450000, 1500000, 1550000,
	1600000, 1650000, 1700000, 1750000, 1800000, 1850000, 1900000, 1950000,
	2000000, 2050000, 2100000, 2150000, 2200000, 2250000, 2300000, 2350000,
	2400000, 2450000, 2500000, 2550000, 2600000, 2650000, 2700000, 2750000,
	2800000, 2850000, 2900000, 2950000, 3000000, 3050000, 3100000, 3150000,
	3200000, 3250000, 3300000,
};

static const unsigned int LDO13_suspend_table[] = {
	1200000, 1250000, 1300000, 1350000, 1400000, 1450000, 1500000, 1550000,
	1600000, 1650000, 1700000, 1750000, 1800000, 1850000, 1900000, 1950000,
	2000000, 2050000, 2100000, 2150000, 2200000, 2250000, 2300000, 2350000,
	2400000, 2450000, 2500000, 2550000, 2600000, 2650000, 2700000, 2750000,
	2800000, 2850000, 2900000, 2950000, 3000000, 3050000, 3100000, 3150000,
	3200000, 3250000, 3300000,
};

static const unsigned int LDO14_table[] = {
	1200000, 1250000, 1300000, 1350000, 1400000, 1450000, 1500000, 1550000,
	1600000, 1650000, 1700000, 1750000, 1800000, 1850000, 1900000, 1950000,
	2000000, 2050000, 2100000, 2150000, 2200000, 2250000, 2300000, 2350000,
	2400000, 2450000, 2500000, 2550000, 2600000, 2650000, 2700000, 2750000,
	2800000, 2850000, 2900000, 2950000, 3000000, 3050000, 3100000, 3150000,
	3200000, 3250000, 3300000,
};

static const unsigned int LDO14_suspend_table[] = {
	1200000, 1250000, 1300000, 1350000, 1400000, 1450000, 1500000, 1550000,
	1600000, 1650000, 1700000, 1750000, 1800000, 1850000, 1900000, 1950000,
	2000000, 2050000, 2100000, 2150000, 2200000, 2250000, 2300000, 2350000,
	2400000, 2450000, 2500000, 2550000, 2600000, 2650000, 2700000, 2750000,
	2800000, 2850000, 2900000, 2950000, 3000000, 3050000, 3100000, 3150000,
	3200000, 3250000, 3300000,
};

static const unsigned int LDO15_table[] = {
	1200000, 1250000, 1300000, 1350000, 1400000, 1450000, 1500000, 1550000,
	1600000, 1650000, 1700000, 1750000, 1800000, 1850000, 1900000, 1950000,
	2000000, 2050000, 2100000, 2150000, 2200000, 2250000, 2300000, 2350000,
	2400000, 2450000, 2500000, 2550000, 2600000, 2650000, 2700000, 2750000,
	2800000, 2850000, 2900000, 2950000, 3000000, 3050000, 3100000, 3150000,
	3200000, 3250000, 3300000,
};

static const unsigned int LDO15_suspend_table[] = {
	1200000, 1250000, 1300000, 1350000, 1400000, 1450000, 1500000, 1550000,
	1600000, 1650000, 1700000, 1750000, 1800000, 1850000, 1900000, 1950000,
	2000000, 2050000, 2100000, 2150000, 2200000, 2250000, 2300000, 2350000,
	2400000, 2450000, 2500000, 2550000, 2600000, 2650000, 2700000, 2750000,
	2800000, 2850000, 2900000, 2950000, 3000000, 3050000, 3100000, 3150000,
	3200000, 3250000, 3300000,
};

static const unsigned int LDO16_table[] = {
	1200000, 1250000, 1300000, 1350000, 1400000, 1450000, 1500000, 1550000,
	1600000, 1650000, 1700000, 1750000, 1800000, 1850000, 1900000, 1950000,
	2000000, 2050000, 2100000, 2150000, 2200000, 2250000, 2300000, 2350000,
	2400000, 2450000, 2500000, 2550000, 2600000, 2650000, 2700000, 2750000,
	2800000, 2850000, 2900000, 2950000, 3000000, 3050000, 3100000, 3150000,
	3200000, 3250000, 3300000,
};

static const unsigned int LDO16_suspend_table[] = {
	1200000, 1250000, 1300000, 1350000, 1400000, 1450000, 1500000, 1550000,
	1600000, 1650000, 1700000, 1750000, 1800000, 1850000, 1900000, 1950000,
	2000000, 2050000, 2100000, 2150000, 2200000, 2250000, 2300000, 2350000,
	2400000, 2450000, 2500000, 2550000, 2600000, 2650000, 2700000, 2750000,
	2800000, 2850000, 2900000, 2950000, 3000000, 3050000, 3100000, 3150000,
	3200000, 3250000, 3300000,
};

static const unsigned int LDO17_table[] = {
	1200000, 1250000, 1300000, 1350000, 1400000, 1450000, 1500000, 1550000,
	1600000, 1650000, 1700000, 1750000, 1800000, 1850000, 1900000, 1950000,
	2000000, 2050000, 2100000, 2150000, 2200000, 2250000, 2300000, 2350000,
	2400000, 2450000, 2500000, 2550000, 2600000, 2650000, 2700000, 2750000,
	2800000, 2850000, 2900000, 2950000, 3000000, 3050000, 3100000, 3150000,
	3200000, 3250000, 3300000,
};

static const unsigned int LDO17_suspend_table[] = {
	1200000, 1250000, 1300000, 1350000, 1400000, 1450000, 1500000, 1550000,
	1600000, 1650000, 1700000, 1750000, 1800000, 1850000, 1900000, 1950000,
	2000000, 2050000, 2100000, 2150000, 2200000, 2250000, 2300000, 2350000,
	2400000, 2450000, 2500000, 2550000, 2600000, 2650000, 2700000, 2750000,
	2800000, 2850000, 2900000, 2950000, 3000000, 3050000, 3100000, 3150000,
	3200000, 3250000, 3300000,
};


static const unsigned int LDO18_table[] = {
	1700000, 1800000, 1900000, 2500000, 2800000, 2900000, 3100000, 3300000,
};

static const unsigned int LDO18_suspend_table[] = {
	1700000, 1800000, 1900000, 2500000, 2800000, 2900000, 3100000, 3300000,
};

static const unsigned int LDO19_table[] = {
	1700000, 1800000, 1900000, 2500000, 2800000, 2900000, 3100000, 3300000,
};

static const unsigned int LDO19_suspend_table[] = {
	1700000, 1800000, 1900000, 2500000, 2800000, 2900000, 3100000, 3300000,
};

static int pm800_list_voltage(struct regulator_dev *rdev, unsigned index)
{
	struct pm800_regulator_info *info = rdev_get_drvdata(rdev);
	int ret = -EINVAL;

	if (info->vol_table && (index < (2 << info->vol_nbits))) {
		ret = info->vol_table[index];
		if (info->slope_double)
			ret = ((ret * 3) / 7);
	}
	return ret;
}

static int choose_voltage(struct regulator_dev *rdev, int min_uV, int max_uV)
{
	struct pm800_regulator_info *info = rdev_get_drvdata(rdev);
	int i, ret = -ENOENT;

	if (info->slope_double) {
		min_uV = (min_uV * 7)/3;
		max_uV = (max_uV * 7)/3;
	}
	if (info->vol_table) {
		for (i = 0; i < (2 << info->vol_nbits); i++) {
			if (!info->vol_table[i])
				break;
			if ((min_uV <= info->vol_table[i])
				&& (max_uV >= info->vol_table[i])) {
				ret = i;
				break;
			}
		}
	}
	if (ret < 0)
		dev_err(info->chip->dev,
			"invalid voltage range (%d %d) uV\n", min_uV, max_uV);

	return ret;
}

static int pm800_set_voltage(struct regulator_dev *rdev,
			      int min_uV, int max_uV)
{
	struct pm800_regulator_info *info = rdev_get_drvdata(rdev);
	uint8_t val, mask;
	int ret;

	if (min_uV > max_uV) {
		dev_err(info->chip->dev,
			"invalid voltage range (%d, %d) uV\n", min_uV, max_uV);
		return -EINVAL;
	}

	ret = choose_voltage(rdev, min_uV, max_uV);
	if (ret < 0)
		return -EINVAL;
	val = (uint8_t)(ret << info->vol_shift);
	mask = ((1 << info->vol_nbits) - 1)  << info->vol_shift;

	ret = pm80x_set_bits(info->i2c, info->vol_reg, mask, val);
	if (ret)
		return ret;
#if 0 /* need to see if needed for PM800*/
	switch (info->desc.id) {
	case PM800_ID_BUCK1:
	case PM800_ID_BUCK3:
		ret = pm80x_set_bits(info->i2c, info->update_reg,
				      1 << info->update_bit,
				      1 << info->update_bit);
		break;
	}
#endif

	/* According to system (E.S)
	 * need to write the same to all LDO1 REGS*/
	if (info->desc.id == PM800_ID_LDO1) {
		ret = pm80x_set_bits(info->i2c, PM800_LDO1_VOUT1, mask, val);
		ret = pm80x_set_bits(info->i2c, PM800_LDO1_VOUT2, mask, val);
	}

	return ret;
}

static int pm800_get_voltage(struct regulator_dev *rdev)
{
	struct pm800_regulator_info *info = rdev_get_drvdata(rdev);
	uint8_t val, mask;
	int ret;

	ret = pm80x_reg_read(info->i2c, info->vol_reg);
	if (ret < 0)
		return ret;

	mask = ((1 << info->vol_nbits) - 1)  << info->vol_shift;
	val = ((unsigned char)ret & mask) >> info->vol_shift;

	return pm800_list_voltage(rdev, val);
}

static int pm800_enable(struct regulator_dev *rdev)
{
	struct pm800_regulator_info *info = rdev_get_drvdata(rdev);

	return pm80x_set_bits(info->i2c, info->enable_reg,
			       1 << info->enable_bit,
			       1 << info->enable_bit);
}

static int pm800_disable(struct regulator_dev *rdev)
{
	struct pm800_regulator_info *info = rdev_get_drvdata(rdev);

	return pm80x_set_bits(info->i2c, info->enable_reg,
			       1 << info->enable_bit, 0);
}

static int pm800_is_enabled(struct regulator_dev *rdev)
{
	struct pm800_regulator_info *info = rdev_get_drvdata(rdev);
	int ret;

	ret = pm80x_reg_read(info->i2c, info->enable_reg);
	if (ret < 0)
		return ret;

	return !!((unsigned char)ret & (1 << info->enable_bit));
}

static struct regulator_ops pm800_regulator_ops = {
	.set_voltage	= pm800_set_voltage,
	.get_voltage	= pm800_get_voltage,
	.enable		= pm800_enable,
	.disable	= pm800_disable,
	.is_enabled	= pm800_is_enabled,
};
/*
vreg - the buck regs string.
nbits - the number of bits that used to set the buck voltage.
ureg - the string for the register that is control by PI2c for sleep,
		for exmp:GO_REGISTER[0x20] in PM8607)
ubit - enable bit for the buck similar to ebit.
ereg -  the string for the enable register.
ebit - the bit number in the enable register.
*/
#define PM800_DVC(vreg, nbits, ureg, ubit, ereg, ebit)			\
{									\
	.desc	= {							\
		.name	= #vreg,					\
		.ops	= &pm800_regulator_ops,			\
		.type	= REGULATOR_VOLTAGE,				\
		.id	= PM800_ID_##vreg,				\
		.owner	= THIS_MODULE,					\
	},								\
	.vol_reg	= PM800_##vreg,				\
	.vol_shift	= (0),						\
	.vol_nbits	= (nbits),					\
	.update_reg	= PM800_##ureg,				\
	.update_bit	= (ubit),					\
	.enable_reg	= PM800_##ereg,				\
	.enable_bit	= (ebit),					\
	.slope_double	= (0),						\
	.vol_table	= (unsigned int *)&vreg##_table,		\
	.vol_suspend	= (unsigned int *)&vreg##_suspend_table,	\
}
/*
_id - the LDO number.
vreg - the LDO regs string
shift - the number of bits we need to shift left for setting LDO voltage.
nbits - the number of bits that used to set the LDO voltage.
ereg -  the string for the enable register.
ebit - the bit number in the enable register.
*/
#define PM800_LDO(_id, vreg, shift, nbits, ereg, ebit)			\
{									\
	.desc	= {							\
		.name	= "LDO" #_id,					\
		.ops	= &pm800_regulator_ops,			\
		.type	= REGULATOR_VOLTAGE,				\
		.id	= PM800_ID_LDO##_id,				\
		.owner	= THIS_MODULE,					\
	},								\
	.vol_reg	= PM800_##vreg##_VOUT,				\
	.vol_shift	= (shift),					\
	.vol_nbits	= (nbits),					\
	.enable_reg	= PM800_##ereg,				\
	.enable_bit	= (ebit),					\
	.slope_double	= (0),						\
	.vol_table	= (unsigned int *)&LDO##_id##_table,		\
	.vol_suspend	= (unsigned int *)&LDO##_id##_suspend_table,	\
}
/*the GO register in the PM800_DVC table need to be consider
  it might be we need to remove this filed from the MACRO*/
static struct pm800_regulator_info pm800_regulator_info[] = {
	PM800_DVC(BUCK1, 7, BUCK_ENA, 0, BUCK_ENA, 0),
	PM800_DVC(BUCK2, 7, BUCK_ENA, 1, BUCK_ENA, 1),
	PM800_DVC(BUCK3, 7, BUCK_ENA, 2, BUCK_ENA, 2),
	PM800_DVC(BUCK4, 7, BUCK_ENA, 3, BUCK_ENA, 3),
	PM800_DVC(BUCK5, 7, BUCK_ENA, 4, BUCK_ENA, 4),

	PM800_LDO(1,	LDO1,	0, 4,	LDO_ENA1_1, 0),
	PM800_LDO(2,	LDO2,	0, 4,	LDO_ENA1_1, 1),
	PM800_LDO(3,	LDO3,	0, 4,	LDO_ENA1_1, 2),
	PM800_LDO(4,	LDO4,	0, 4,	LDO_ENA1_1, 3),
	PM800_LDO(5,	LDO5,	0, 4,	LDO_ENA1_1, 4),
	PM800_LDO(6,	LDO6,	0, 4,	LDO_ENA1_1, 5),
	PM800_LDO(7,	LDO7,	0, 4,	LDO_ENA1_1, 6),
	PM800_LDO(8,	LDO8,	0, 4,	LDO_ENA1_1, 7),
	PM800_LDO(9,	LDO9,	0, 4,	LDO_ENA1_2, 0),
	PM800_LDO(10,	LDO10,	0, 4,	LDO_ENA1_2, 1),
	PM800_LDO(11,	LDO11,	0, 4,	LDO_ENA1_2, 2),
	PM800_LDO(12,	LDO12,	0, 4,	LDO_ENA1_2, 3),
	PM800_LDO(13,	LDO13,	0, 4,	LDO_ENA1_2,	4),
	PM800_LDO(14,	LDO14,	0, 4,	LDO_ENA1_2, 5),
	PM800_LDO(15,	LDO15,	0, 4,	LDO_ENA1_2, 6),
	PM800_LDO(16,	LDO16,	0, 4,	LDO_ENA1_2, 7),
	PM800_LDO(17,	LDO17,	0, 4,	LDO_ENA1_3, 0),
	PM800_LDO(18,	LDO18,	0, 4,	LDO_ENA1_3, 1),
	PM800_LDO(19,	LDO19,	0, 4,	LDO_ENA1_3, 2),
};

static int __devinit pm800_regulator_probe(struct platform_device *pdev)
{
	struct pm80x_chip *chip = dev_get_drvdata(pdev->dev.parent);
	struct pm800_regulator_info *info = NULL;
	struct regulator_init_data *pdata;
	int i;

	pdata = platform_get_drvdata(pdev);
	if (pdata == NULL)
		return -EINVAL;

	for (i = 0; i < ARRAY_SIZE(pm800_regulator_info); i++) {
		info = &pm800_regulator_info[i];
		if (!strcmp(info->desc.name, pdata->constraints.name))
			break;
	}
	if (i > ARRAY_SIZE(pm800_regulator_info)) {
		dev_err(&pdev->dev, "Failed to find regulator %s\n",
			pdata->constraints.name);
		return -EINVAL;
	}

	info->i2c = (chip->id == CHIP_PM800) ? chip->client : chip->companion;
	info->chip = chip;

/*	in PM800 there are 2 range for all bucks:
	from 0x00 to 0x3F VOUT step
	is 0.0125V, range is from 0.6V to 1.3875V.
	and
	from 0x40 to 0x7F VOUT step
	is 0.05V, range is from 1.4V to 4.550V:*/

	/* check DVC ramp slope double */

	if (!strcmp(info->desc.name, "BUCK1") ||
		!strcmp(info->desc.name, "BUCK2") ||
		!strcmp(info->desc.name, "BUCK3") ||
		!strcmp(info->desc.name, "BUCK4") ||
		!strcmp(info->desc.name, "BUCK5"))
		info->slope_double = 1;

	info->regulator = regulator_register(&info->desc, &pdev->dev,
					     pdata, info);
	if (IS_ERR(info->regulator)) {
		dev_err(&pdev->dev, "failed to register regulator %s\n",
			info->desc.name);
		return PTR_ERR(info->regulator);
	}

	platform_set_drvdata(pdev, info);
	return 0;
}

static int __devexit pm800_regulator_remove(struct platform_device *pdev)
{
	struct pm800_regulator_info *info = platform_get_drvdata(pdev);

	platform_set_drvdata(pdev, NULL);
	regulator_unregister(info->regulator);
	return 0;
}

static struct platform_driver pm800_regulator_driver = {
	.driver		= {
		.name	= "88pm80x-regulator",
		.owner	= THIS_MODULE,
	},
	.probe		= pm800_regulator_probe,
	.remove		= __devexit_p(pm800_regulator_remove),
};

static int __init pm800_regulator_init(void)
{
	return platform_driver_register(&pm800_regulator_driver);
}
subsys_initcall(pm800_regulator_init);

static void __exit pm800_regulator_exit(void)
{
	platform_driver_unregister(&pm800_regulator_driver);
}
module_exit(pm800_regulator_exit);

MODULE_LICENSE("GPL");
MODULE_AUTHOR("Joseph(Yossi) Hanin <yhanin@marvell.com>");
MODULE_DESCRIPTION("Regulator Driver for Marvell 88PM800 PMIC");
MODULE_ALIAS("platform:88pm800-regulator");
